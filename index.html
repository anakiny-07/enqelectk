<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบค้นหากลุ่มจังหวัดออกเสียงประชามตินอกเขต</title>
    
    <!-- นำเข้า Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- นำเข้า React และ Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ฟอนต์ภาษาไทย -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="root"></div>

    <script type="text/babel">
        // --- การตั้งค่า (Configuration) ---
        // ใส่ลิงก์ CSV จาก Google Sheet ของคุณที่นี่
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRMCW4h7i974_KGO1cWBNLeCTuCA80qO7wsUJhZPBYmXlNapbYT4l_pw3N4joUuj4h_uekoTPXq0l-J/pub?output=csv"; 

        const { useState, useEffect } = React;

        // ไอคอน (Inline SVGs)
        const Icons = {
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            WifiOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>
        };

        function App() {
            const [data, setData] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [filteredResults, setFilteredResults] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isOfflineMode, setIsOfflineMode] = useState(false);

            // ฟังก์ชันแปลง CSV
            const parseCSV = (text) => {
                const lines = text.split('\n');
                return lines.slice(1).map((line, index) => {
                    // รองรับกรณี CSV มีเครื่องหมายคำพูด (Simple CSV parser)
                    let values = [];
                    let current = '';
                    let inQuotes = false;
                    for (let char of line) {
                        if (char === '"') { inQuotes = !inQuotes; }
                        else if (char === ',' && !inQuotes) { values.push(current); current = ''; }
                        else { current += char; }
                    }
                    values.push(current);

                    // map ข้อมูล (ปรับได้ตามคอลัมน์จริง)
                    return {
                        id: index,
                        group: values[0]?.trim().replace(/"/g, '') || "-",
                        region: values[1]?.trim().replace(/"/g, '') || "-",
                        province: values[2]?.trim().replace(/"/g, '') || "-"
                    };
                }).filter(item => item.province !== "-" && item.province !== "");
            };

            // ฟังก์ชัน fetch พร้อม Timeout
            const fetchWithTimeout = (url, timeout = 5000) => {
                return Promise.race([
                    fetch(url),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('โหลดนานเกินไป (Timeout)')), timeout))
                ]);
            };

            useEffect(() => {
                if (!GOOGLE_SHEET_CSV_URL) return;

                const fetchData = async () => {
                    setIsLoading(true);
                    setError(null);
                    setIsOfflineMode(false);
                    
                    let csvText = null;

                    try {
                        // 1. ลอง Proxy หลัก (corsproxy.io) - เร็วและเสถียร
                        try {
                            const proxy1 = `https://corsproxy.io/?${encodeURIComponent(GOOGLE_SHEET_CSV_URL)}`;
                            const response = await fetchWithTimeout(proxy1, 5000); 
                            if (response.ok) {
                                csvText = await response.text();
                            } else {
                                throw new Error('Proxy 1 failed');
                            }
                        } catch (e) {
                            console.warn('Proxy 1 error, trying Proxy 2...');
                            // 2. ถ้า Proxy 1 พัง, ลอง Proxy สำรอง (allorigins)
                            const proxy2 = `https://api.allorigins.win/raw?url=${encodeURIComponent(GOOGLE_SHEET_CSV_URL)}`;
                            const response = await fetchWithTimeout(proxy2, 8000);
                            if (response.ok) {
                                csvText = await response.text();
                            } else {
                                throw new Error('เชื่อมต่อ Google Sheet ไม่สำเร็จ');
                            }
                        }

                        // ถ้าได้ข้อมูลมา: แปลงข้อมูล + บันทึกลงเครื่อง (Cache)
                        const parsedData = parseCSV(csvText);
                        setData(parsedData);
                        localStorage.setItem('election_data_cache', JSON.stringify(parsedData)); // Save to cache

                    } catch (err) {
                        console.error("Fetch Error:", err);
                        
                        // 3. ถ้าดึงไม่ได้เลย ให้ลองดูข้อมูลเก่าในเครื่อง (Offline Mode)
                        const cachedData = localStorage.getItem('election_data_cache');
                        if (cachedData) {
                            setData(JSON.parse(cachedData));
                            setIsOfflineMode(true);
                        } else {
                            setError('ไม่สามารถเชื่อมต่อข้อมูลได้ กรุณาตรวจสอบอินเทอร์เน็ตแล้วลองใหม่');
                        }
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, []);

            // ระบบค้นหา
            useEffect(() => {
                const cleanTerm = searchTerm.trim();
                if (cleanTerm.length >= 3) {
                    const results = data.filter(item => 
                        item.province && item.province.includes(cleanTerm)
                    );
                    setFilteredResults(results);
                } else {
                    setFilteredResults([]);
                }
            }, [searchTerm, data]);

            return (
                <div className="min-h-screen pb-12 bg-slate-50">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-blue-700 to-indigo-800 text-white py-8 px-4 shadow-lg relative overflow-hidden">
                        <div className="max-w-3xl mx-auto text-center relative z-10">
                            <div className="flex justify-center mb-4 opacity-90"><Icons.Database /></div>
                            <h1 className="text-2xl md:text-4xl font-bold mb-2">ระบบค้นหากลุ่มจังหวัดเลือกตั้ง</h1>
                            <p className="text-blue-100 text-sm">ตรวจสอบข้อมูล ชุดที่, ภาค และจังหวัด</p>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-3xl mx-auto px-4 -mt-6 relative z-20">

                        {/* Config Alert */}
                        {!GOOGLE_SHEET_CSV_URL && (
                            <div className="bg-white rounded-xl shadow-xl p-6 mb-6 text-center border-l-4 border-amber-500">
                                <div className="text-amber-500 mx-auto mb-2 flex justify-center"><Icons.Settings /></div>
                                <h2 className="font-bold text-slate-800">ยังไม่ได้ใส่ลิงก์ข้อมูล</h2>
                                <p className="text-slate-600 text-sm">แก้ไฟล์ <code>index.html</code> แล้วใส่ลิงก์ที่บรรทัด <code>const GOOGLE_SHEET_CSV_URL</code></p>
                            </div>
                        )}

                        {/* Search Box */}
                        {GOOGLE_SHEET_CSV_URL && (
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <label className="block text-sm font-medium text-slate-600 mb-2">ค้นหาจังหวัด</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                        <Icons.Search />
                                    </div>
                                    <input
                                        type="text"
                                        className="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-base"
                                        placeholder="พิมพ์ชื่อจังหวัด..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                <div className="mt-2 text-xs text-slate-500">
                                    {searchTerm.length > 0 && searchTerm.length < 3 ? 
                                        <span className="text-amber-600 font-medium">กรุณาพิมพ์อย่างน้อย 3 ตัวอักษร</span> : 
                                        <span>* พิมพ์อย่างน้อย 3 ตัวอักษรเพื่อค้นหา</span>
                                    }
                                </div>
                            </div>
                        )}

                        {/* Status: Offline Mode Warning */}
                        {isOfflineMode && (
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6 flex items-start gap-3 text-amber-800">
                                <div className="mt-1 flex-shrink-0"><Icons.WifiOff /></div>
                                <div>
                                    <p className="font-bold text-sm">แสดงผลแบบออฟไลน์</p>
                                    <p className="text-xs mt-1">ไม่สามารถเชื่อมต่อข้อมูลล่าสุดได้ ระบบกำลังแสดงข้อมูลเดิมที่บันทึกไว้ในเครื่อง</p>
                                </div>
                            </div>
                        )}

                        {/* Status: Error */}
                        {error && (
                            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 text-center text-red-700">
                                <div className="flex justify-center mb-2"><Icons.AlertCircle /></div>
                                <p className="font-medium text-sm">{error}</p>
                                <button 
                                    onClick={() => window.location.reload()} 
                                    className="mt-3 text-xs bg-red-100 hover:bg-red-200 text-red-800 px-4 py-2 rounded-full transition"
                                >
                                    ลองรีเฟรชหน้าเว็บ
                                </button>
                            </div>
                        )}

                        {/* Status: Loading */}
                        {isLoading && (
                            <div className="text-center py-8">
                                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-700 mx-auto mb-3"></div>
                                <p className="text-slate-500 text-sm">กำลังเชื่อมต่อข้อมูล...</p>
                            </div>
                        )}

                        {/* Results */}
                        {!isLoading && !error && GOOGLE_SHEET_CSV_URL && (
                            <div className="space-y-3">
                                {searchTerm.length >= 3 && filteredResults.length === 0 ? (
                                    <div className="text-center py-8 bg-white rounded-lg border border-slate-200">
                                        <p className="text-slate-500">ไม่พบข้อมูล "{searchTerm}"</p>
                                    </div>
                                ) : (
                                    <>
                                        {filteredResults.length > 0 && (
                                            <div className="flex justify-between items-end px-1 mb-1">
                                                <h2 className="text-lg font-bold text-slate-800">ผลการค้นหา</h2>
                                                <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{filteredResults.length} รายการ</span>
                                            </div>
                                        )}
                                        {filteredResults.map((item, idx) => (
                                            <div key={idx} className="bg-white border border-slate-200 rounded-lg shadow-sm p-4 flex justify-between items-center group border-l-4 border-l-blue-500 hover:shadow-md transition">
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-blue-500"><Icons.MapPin /></span>
                                                        <h3 className="text-lg font-bold text-slate-900">จ.{item.province}</h3>
                                                    </div>
                                                    <p className="text-slate-500 text-sm pl-8">ภาค: <span className="font-medium text-slate-800">{item.region}</span></p>
                                                </div>
                                                <div className="text-center bg-slate-50 px-4 py-2 rounded-lg border border-slate-100 min-w-[80px]">
                                                    <span className="block text-[10px] text-slate-500 uppercase font-bold">ชุดที่</span>
                                                    <span className="block text-2xl font-bold text-blue-600">{item.group}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
